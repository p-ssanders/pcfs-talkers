resources:
- name: git-repository
  type: git
  source:
    uri: git@github.com:p-ssanders/slack-talkers.git
    branch: master
    private_key: ((git-deploy-key.private_key))
    ignore_paths:
    - Dockertag

- name: docker-tag
  type: semver
  source:
    driver: git
    uri: git@github.com:p-ssanders/slack-talkers.git
    branch: master
    private_key: ((git-deploy-key.private_key))
    file: Dockertag

- name: docker-image
  type: docker-image
  source:
    repository: ssanders0/slack-talkers
    username: ssanders0
    password: ((dockerhub-password))

jobs:
- name: test
  plan:
  - get: git-repository
    trigger: true
  - task: test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: openjdk
          tag: 11-jdk-slim
      inputs:
      - name: git-repository
      run:
        path: bash
        args:
        - "-c"
        - |
          set -eux
          cd git-repository
          ./mvnw test
  - put: docker-tag
    params:
      bump: patch

- name: build
  plan:
  - get: git-repository
    passed:
    - test
  - get: docker-tag
    trigger: true
    passed:
    - test
  - task: package
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: openjdk
          tag: 11-jdk-slim
      inputs:
      - name: git-repository
      - name: docker-tag
      outputs:
      - name: workspace
      run:
        path: bash
        args:
        - "-c"
        - |
          set -eux
          cd git-repository
          ./mvnw -DskipTests package
          cd ..
          cp -r git-repository/* workspace/

          cat docker-tag/number

          cat docker-tag/number > workspace/Dockertag
  - put: docker-image
    params:
      build: workspace
      tag_file: workspace/Dockertag
